<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hazard Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ff9800" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <h2>Hazard Map</h2>
    <label id="uploadLabel" for="uploadBtn">Upload floorplan:</label>
    <input id="uploadBtn" type="file" accept="image/*">
  </div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Menu button -->
  <button id="menuBtn">â˜°</button>

  <!-- Map -->
  <div id="map"></div>

  <!-- Floating add button -->
  <div class="fab" id="addBtn">+</div>

  <!-- Picker modal -->
  <div id="picker">
    <div class="box">
      <div>Select a hazard style:</div>
      <div class="shape-row" id="options"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  const map = L.map('map',{ crs:L.CRS.Simple, zoomControl:false, minZoom:-5, attributionControl:false });
  let imageLayer, imageW=2000, imageH=1500;
  const markers = L.featureGroup().addTo(map);

  const colors = ["red","orange","yellow","green","blue","purple"];
  const shapes = ["circle","square","triangle"];

  // --- SIDEBAR TOGGLE ---
  const sidebar=document.getElementById("sidebar");
  const overlay=document.getElementById("overlay");
  const menuBtn=document.getElementById("menuBtn");

  menuBtn.onclick=()=>{
    if(sidebar.classList.contains("open")){
      sidebar.classList.remove("open");
      overlay.classList.remove("show");
    } else {
      sidebar.classList.add("open");
      overlay.classList.add("show");
    }
  };
  overlay.onclick=()=>{
    sidebar.classList.remove("open");
    overlay.classList.remove("show");
  };

  // --- IMAGE LOADING ---
  function loadImage(src){
    const img=new Image();
    img.onload=()=>{
      imageW=img.width; imageH=img.height;
      if(imageLayer) map.removeLayer(imageLayer);
      const bounds=[[0,0],[imageH,imageW]];
      imageLayer=L.imageOverlay(src,bounds).addTo(map);
      map.setMaxBounds(bounds); map.fitBounds(bounds);
    };
    img.src=src;
  }

  document.getElementById('uploadBtn').addEventListener('change',e=>{
    if(e.target.files[0]) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        const base64 = ev.target.result;
        localStorage.setItem("floorplan", base64);
        loadImage(base64);
      };
      reader.readAsDataURL(e.target.files[0]);
    }
  });

  // --- PERSISTENCE ---
  function saveHazards() {
    const arr = [];
    markers.eachLayer(m => {
      const ll = m.getLatLng();
      arr.push({
        note: m.hazardData.note,
        x: ll.lng,
        y: ll.lat,
        color: m.hazardData.color,
        shape: m.hazardData.shape
      });
    });
    localStorage.setItem("hazards", JSON.stringify(arr));
  }

  function loadHazards() {
    const data = localStorage.getItem("hazards");
    if (!data) return;
    try {
      const arr = JSON.parse(data);
      arr.forEach(h => {
        createMarker([h.y, h.x], h.color, h.shape, h.note);
      });
    } catch(e) {
      console.error("Failed to load hazards", e);
    }
  }

  // --- MARKERS ---
  function markerPopup(marker){
    const data=marker.hazardData||{note:''};
    const div=document.createElement('div');
    div.classList.add("popup");
    div.innerHTML=`
      <textarea id="note">${data.note||''}</textarea>
      <div><button id="save">Save</button>
      <button id="del">Delete</button></div>`;
    div.querySelector('#save').onclick=()=>{
      marker.hazardData.note=div.querySelector('#note').value;
      saveHazards();
      marker.closePopup();
    };
    div.querySelector('#del').onclick=()=>{
      markers.removeLayer(marker);
      saveHazards();
    };
    return div;
  }

  function createMarker(latlng, color="red", shape="circle", note="") {
    let html="";
    if(shape==="circle") {
      html = `<div style="background:${color}; width:20px; height:20px; border-radius:50%; border:2px solid #333;"></div>`;
    } else if(shape==="square") {
      html = `<div style="background:${color}; width:20px; height:20px; border:2px solid #333;"></div>`;
    } else if(shape==="triangle") {
      html = `<div style="width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:20px solid ${color};"></div>`;
    }

    const icon = L.divIcon({
      className: "custom-marker",
      html: html,
      iconSize:[20,20],
      iconAnchor:[10,10]
    });

    const m=L.marker(latlng,{draggable:true, icon}).addTo(markers);
    m.hazardData={note, color, shape};
    m.bindPopup(()=>markerPopup(m));
    m.on("dragend", () => saveHazards());
    saveHazards();
    return m;
  }

  // --- ADD MARKER WORKFLOW ---
  document.getElementById('addBtn').onclick=()=>{
    buildPicker();
    document.getElementById("picker").style.display="flex";
  };

  function buildPicker(){
    const container=document.getElementById("options");
    container.innerHTML="";
    shapes.forEach(shape=>{
      colors.forEach(color=>{
        let html="";
        if(shape==="circle"){
          html=`<div class="marker-preview circle" style="background:${color};"></div>`;
        } else if(shape==="square"){
          html=`<div class="marker-preview square" style="background:${color};"></div>`;
        } else if(shape==="triangle"){
          html=`<div class="marker-preview triangle" style="border-bottom-color:${color};"></div>`;
        }
        const el=document.createElement("div");
        el.innerHTML=html;
        const choice=el.firstChild;
        choice.onclick=()=>{
          document.getElementById("picker").style.display="none";
          map.once('click',e=>createMarker(e.latlng, color, shape, ""));
          alert("Tap where you want to add a hazard");
        };
        container.appendChild(choice);
      });
    });
  }

  // --- INIT ---
  const savedPlan = localStorage.getItem("floorplan");
  if (savedPlan) loadImage(savedPlan);
  loadHazards();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
  </script>
</body>
</html>
