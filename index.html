<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hazard Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ff9800" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .section-title { margin-top: 16px; margin-bottom: 8px; font-weight: 600; color:#ff9800; }
    .row { display:flex; gap:8px; align-items:center; }
    .row input[type="text"] {
      flex:1; padding:6px 8px; border-radius:8px; border:1px solid #444;
      background:#2a2a2a; color:#e0e0e0;
    }
    .list { max-height: 40vh; overflow:auto; margin-top:8px; }
    .item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; border-radius:8px; background:#2a2a2a; margin-bottom:6px; }
    .item-name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .btn-sm { padding:6px 8px; border:none; border-radius:8px; background:#ff9800; color:#000; cursor:pointer; font-size:12px; }
    .btn-sm:hover { background:#e68900; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <h2>Hazard Map</h2>
    <label id="uploadLabel" for="uploadBtn">Upload floorplan:</label>
    <input id="uploadBtn" type="file" accept="image/*">

    <!-- Saved Projects -->
    <div class="section-title">Projects</div>
    <div class="row">
      <input id="projectName" type="text" placeholder="Project name"/>
      <button id="saveProjectBtn" class="btn-sm">Save</button>
    </div>
    <div id="projectsList" class="list"></div>

    <!-- Export / Import -->
    <div class="section-title">Share</div>
    <button id="exportBtn" class="btn-sm">Export Project</button>
    <input id="importFile" type="file" accept=".json" style="display:none">
    <button id="importBtn" class="btn-sm">Import Project</button>
  </div>

  <!-- Menu button -->
  <button id="menuBtn">â˜°</button>

  <!-- Map -->
  <div id="map"></div>

  <!-- Floating add button -->
  <div class="fab" id="addBtn">+</div>

  <!-- Picker modal -->
  <div id="picker">
    <div class="box">
      <div>Select a hazard style:</div>
      <div class="shape-row" id="options"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  const map = L.map('map',{ crs:L.CRS.Simple, zoomControl:false, minZoom:-5, attributionControl:false });
  let imageLayer, imageW=2000, imageH=1500;
  const markers = L.featureGroup().addTo(map);

  const colors = ["red","orange","yellow","green","blue","purple"];
  const shapes = ["circle","square","triangle"];

  // --- SIDEBAR TOGGLE ---
  const sidebar=document.getElementById("sidebar");
  const menuBtn=document.getElementById("menuBtn");
  menuBtn.onclick=()=> sidebar.classList.toggle("open");

  // --- FLOORPLAN LOADING ---
  function fitAndShowImage(src) {
    const img=new Image();
    img.onload=()=>{
      imageW=img.width; imageH=img.height;
      if(imageLayer) map.removeLayer(imageLayer);
      const bounds=[[0,0],[imageH,imageW]];
      imageLayer=L.imageOverlay(src,bounds).addTo(map);
      map.setMaxBounds(bounds); map.fitBounds(bounds);
      document.getElementById("map").style.background = "#1a1a1a";
    };
    img.src=src;
  }

  function loadImageBase64(base64){
    localStorage.setItem("floorplan", base64);
    fitAndShowImage(base64);
  }

  // FIX: Clear markers when a new floorplan is uploaded
  document.getElementById('uploadBtn').addEventListener('change',e=>{
    const f = e.target.files?.[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const base64 = ev.target.result;
      localStorage.setItem("floorplan", base64);
      fitAndShowImage(base64);
      // Clear existing hazards
      markers.clearLayers();
      localStorage.setItem("hazards", JSON.stringify([]));
    };
    reader.readAsDataURL(f);
  });

  // --- MARKERS ---
  function markerPopup(marker){
    const data=marker.hazardData || { note:'' };
    const div=document.createElement('div');
    div.classList.add("popup");
    div.innerHTML=`
      <textarea id="note">${data.note||''}</textarea>
      <div style="display:flex; gap:6px; margin-top:8px;">
        <button id="save" class="btn-sm">Save</button>
        <button id="del" class="btn-sm">Delete</button>
      </div>
    `;
    div.querySelector('#save').onclick=()=>{
      marker.hazardData.note=div.querySelector('#note').value;
      saveHazards();
      marker.closePopup();
    };
    div.querySelector('#del').onclick=()=>{
      markers.removeLayer(marker);
      saveHazards();
      marker.closePopup();
    };
    return div;
  }

  function createMarker(latlng, color="red", shape="circle", note="") {
    let html="";
    if(shape==="circle") {
      html = `<div style="background:${color}; width:20px; height:20px; border-radius:50%; border:2px solid #333;"></div>`;
    } else if(shape==="square") {
      html = `<div style="background:${color}; width:20px; height:20px; border:2px solid #333;"></div>`;
    } else {
      html = `<div style="width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:20px solid ${color};"></div>`;
    }

    const icon = L.divIcon({
      className: "custom-marker",
      html: html, iconSize:[20,20], iconAnchor:[10,10]
    });

    const m=L.marker(latlng,{draggable:true, icon}).addTo(markers);
    m.hazardData={ note, color, shape };
    m.bindPopup(()=>markerPopup(m));
    m.on("dragend", () => saveHazards());
    saveHazards();
    return m;
  }

  // --- ADD MARKER WORKFLOW ---
  document.getElementById('addBtn').onclick=()=>{
    buildPicker();
    document.getElementById("picker").style.display="flex";
  };

  function buildPicker(){
    const container=document.getElementById("options");
    container.innerHTML="";
    shapes.forEach(shape=>{
      colors.forEach(color=>{
        let html="";
        if(shape==="circle"){
          html=`<div class="marker-preview circle" style="background:${color};"></div>`;
        } else if(shape==="square"){
          html=`<div class="marker-preview square" style="background:${color};"></div>`;
        } else {
          html=`<div class="marker-preview triangle" style="border-bottom-color:${color};"></div>`;
        }
        const el=document.createElement("div");
        el.innerHTML=html;
        const choice=el.firstChild;
        choice.onclick=()=>{
          document.getElementById("picker").style.display="none";
          map.once('click',e=>createMarker(e.latlng, color, shape, ""));
        };
        container.appendChild(choice);
      });
    });
  }

  // Close picker if clicking outside
  window.addEventListener("click",(e)=>{
    const picker=document.getElementById("picker");
    if(picker.style.display==="flex" && !picker.contains(e.target) && !e.target.closest("#addBtn")){
      picker.style.display="none";
    }
  });

  // --- LOCAL SAVE / LOAD MULTIPLE PROJECTS ---
  function saveHazards() {
    const arr = [];
    markers.eachLayer(m => {
      const ll = m.getLatLng();
      arr.push({
        note: m.hazardData.note,
        x: ll.lng,
        y: ll.lat,
        color: m.hazardData.color,
        shape: m.hazardData.shape
      });
    });
    localStorage.setItem("hazards", JSON.stringify(arr));
  }

  function loadHazards() {
    markers.clearLayers();
    const data = localStorage.getItem("hazards");
    if (!data) return;
    try {
      const arr = JSON.parse(data);
      arr.forEach(h => createMarker([h.y, h.x], h.color, h.shape, h.note));
    } catch(e) { console.error(e); }
  }

  function getProjects(){
    try { return JSON.parse(localStorage.getItem("projects")||"[]"); }
    catch { return []; }
  }
  function setProjects(list){
    localStorage.setItem("projects", JSON.stringify(list));
    renderProjectsList();
  }

  function renderProjectsList(){
    const box=document.getElementById("projectsList");
    const projects=getProjects();
    box.innerHTML="";
    projects.forEach((p,i)=>{
      const row=document.createElement("div");
      row.className="item";
      row.innerHTML=`
        <div class="item-name">${p.name}</div>
        <div style="display:flex; gap:6px;">
          <button class="btn-sm" data-act="load" data-i="${i}">Load</button>
          <button class="btn-sm" data-act="delete" data-i="${i}">Del</button>
        </div>`;
      box.appendChild(row);
    });
    box.querySelectorAll("button").forEach(btn=>{
      const act=btn.dataset.act, i=parseInt(btn.dataset.i,10);
      if (act==="load") btn.onclick=()=> loadProject(i);
      if (act==="delete") btn.onclick=()=> deleteProject(i);
    });
  }

  function saveCurrentAsProject(name){
    if (!name) return alert("Enter a name");
    const project={
      name,
      floorplan: localStorage.getItem("floorplan")||null,
      hazards: JSON.parse(localStorage.getItem("hazards")||"[]")
    };
    const projects=getProjects();
    projects.push(project);
    setProjects(projects);
  }
  function loadProject(i){
    const p=getProjects()[i];
    if (!p) return;
    if (p.floorplan) {
      localStorage.setItem("floorplan", p.floorplan);
      fitAndShowImage(p.floorplan);
    }
    localStorage.setItem("hazards", JSON.stringify(p.hazards||[]));
    loadHazards();
  }
  function deleteProject(i){
    const projects=getProjects();
    projects.splice(i,1);
    setProjects(projects);
  }

  document.getElementById("saveProjectBtn").onclick=()=>{
    const name=document.getElementById("projectName").value.trim();
    saveCurrentAsProject(name);
    document.getElementById("projectName").value="";
  };

  // --- EXPORT / IMPORT ---
  document.getElementById("exportBtn").onclick=()=>{
    const current={
      floorplan: localStorage.getItem("floorplan")||null,
      hazards: JSON.parse(localStorage.getItem("hazards")||"[]")
    };
    const blob=new Blob([JSON.stringify(current)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="hazardmap_project.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  document.getElementById("importBtn").onclick=()=> document.getElementById("importFile").click();
  document.getElementById("importFile").addEventListener("change", e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try {
        const data=JSON.parse(ev.target.result);
        if (data.floorplan) {
          localStorage.setItem("floorplan", data.floorplan);
          fitAndShowImage(data.floorplan);
        }
        localStorage.setItem("hazards", JSON.stringify(data.hazards||[]));
        loadHazards();
        alert("Project imported!");
      } catch(err) {
        alert("Invalid JSON file");
      }
    };
    reader.readAsText(f);
  });

  // --- INIT ---
  const savedPlan=localStorage.getItem("floorplan");
  if (savedPlan) fitAndShowImage(savedPlan);
  loadHazards();
  renderProjectsList();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
  </script>
</body>
</html>
